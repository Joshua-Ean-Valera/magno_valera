<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeGrounds - Map</title>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.7); /* Transparent overlay */
            color: white; /* Text color for readability */
        }
        header {
            background-color: black;
            color: white;
            padding: 20px 0;
            font-size: 24px;
        }
        #map {
            height: 400px; /* Reduced height for a more compact map */
            width: 80%;
            margin: 20px auto;
            border: 2px solid #ccc;
            border-radius: 10px;
        }
        .btn-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        button {
            padding: 12px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #0078FF;
            color: white;
            border: none;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            background-color: #0056b3;
        }
        .leaflet-popup-content {
            font-size: 16px;
        }
        select#disaster-filter {
        padding: 10px 18px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        background-color: #222c36;
        color: #fff;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        margin-right: 10px;
        outline: none;
        transition: background 0.2s, color 0.2s;
        }
        select#disaster-filter:focus {
            background-color: #0078FF;
            color: #fff;
        }
        select#disaster-filter option {
            background: #222c36;
            color: #fff;
        }
    </style>
</head>
<body>
    <header>
        <h1>SAFEGROUNDS MAP</h1>
    </header>
    <div class="btn-container">
        <button id="show-centers">Show Evacuation Centers</button>
        <button onclick="window.location.href='/'">Home</button>
        <select id="disaster-filter">
            <option value="">All Disasters</option>
            <option value="Flood">Flood</option>
            <option value="Storm">Storm</option>
            <option value="Earthquake">Earthquake</option>
        </select>
    </div>
    <div id="map"></div>
    <script>
        // const map = L.map('map').setView([13.453, 123.368], 15);

        // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     maxZoom: 19,
        // }).addTo(map);

        // const evacuationCenters = [];
        // const disasterFilter = document.getElementById('disaster-filter');
        // let markers = [];

        // // Fetch evacuation center data
        // fetch('/get_evacuations')
        //     .then(response => response.json())
        //     .then(data => {
        //         data.forEach(center => evacuationCenters.push(center));
        //     });

        // // Toggle evacuation center markers
        // let markersVisible = false;
        // const showCentersBtn = document.getElementById('show-centers');

        // showCentersBtn.addEventListener('click', () => {
        //     // Remove existing markers if visible
        //     if (markersVisible) {
        //         markers.forEach(marker => map.removeLayer(marker));
        //         markers = [];
        //         markersVisible = false;
        //     } else {
        //         // Get selected disaster type
        //         const selectedDisaster = disasterFilter.value;
        //         // Filter centers
        //         const filteredCenters = selectedDisaster
        //             ? evacuationCenters.filter(center => center.safe_for.includes(selectedDisaster))
        //             : evacuationCenters;
        //         // Add markers for filtered centers
        //         filteredCenters.forEach(center => {
        //             const status = center.is_full
        //                 ? "<span style='color:red;font-weight:bold;'>Full</span>"
        //                 : "<span style='color:green;font-weight:bold;'>Available</span>";
        //             const marker = L.marker([center.lat, center.lng])
        //                 .addTo(map)
        //                 .bindPopup(`${center.name}<br>Status: ${status}<br>Safe for: ${center.safe_for.join(", ")}`);
        //             markers.push(marker);
        //         });
        //         markersVisible = true;
        //     }
        // });
        // // Click event to find closest center
        // map.on('click', function (e) {
        //     fetch('/closest_center', {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ lat: e.latlng.lat, lng: e.latlng.lng })
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         const popup = L.popup()
        //             .setLatLng(e.latlng)
        //             .setContent(`Closest Center: ${data.closest.name}<br>Distance: ${data.distance} km`)
        //             .openOn(map);
        //     });
        // });
        
        const map = L.map('map').setView([13.453, 123.368], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        const evacuationCenters = [];
        const disasterFilter = document.getElementById('disaster-filter');
        const showCentersBtn = document.getElementById('show-centers');
        let markers = [];
        let userMarker = null;

        // Show instruction to user
        alert("Please click on the map to select your current location.");

        // Fetch evacuation center data
        fetch('/get_evacuations')
            .then(response => response.json())
            .then(data => {
                data.forEach(center => evacuationCenters.push(center));
            });

        // Listen for user click to set their location and show closest center
        map.on('click', function (e) {
            // Remove previous user marker if any
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            // Mark user's location
            userMarker = L.marker(e.latlng)
                .addTo(map)
                .bindPopup("You are here.")
                .openPopup();

            // Filter centers by disaster type
            const selectedDisaster = disasterFilter.value;
            const filteredCenters = selectedDisaster
                ? evacuationCenters.filter(center => center.safe_for.includes(selectedDisaster))
                : evacuationCenters;

            if (filteredCenters.length === 0) {
                alert("No evacuation centers are available nearby for the selected disaster type.");
                // Remove previous center markers
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                return;
            }

            // Find the closest center
            let minDist = Infinity;
            let closest = null;
            filteredCenters.forEach(center => {
                const dist = map.distance(e.latlng, L.latLng(center.lat, center.lng));
                if (dist < minDist) {
                    minDist = dist;
                    closest = center;
                }
            });

            // Remove previous center markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Show only the closest center
            if (closest) {
                const status = closest.is_full
                    ? "<span style='color:red;font-weight:bold;'>Full</span>"
                    : "<span style='color:green;font-weight:bold;'>Available</span>";
                const marker = L.marker([closest.lat, closest.lng])
                    .addTo(map)
                    .bindPopup(`${closest.name}<br>Status: ${status}<br>Safe for: ${closest.safe_for.join(", ")}`);
                markers.push(marker);
                marker.openPopup();
            }
        });

        // Optionally, update results if disaster filter changes (re-run closest search)
        disasterFilter.addEventListener('change', () => {
            if (userMarker) {
                userMarker.fire('click');
            }
        });

        // (Optional) Show all evacuation centers when button is clicked
        showCentersBtn.addEventListener('click', () => {
            // Remove previous center markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Filter centers by disaster type
            const selectedDisaster = disasterFilter.value;
            const filteredCenters = selectedDisaster
                ? evacuationCenters.filter(center => center.safe_for.includes(selectedDisaster))
                : evacuationCenters;

            if (filteredCenters.length === 0) {
                alert("No evacuation centers are available for the selected disaster type.");
                return;
            }

            // Show all filtered centers
            filteredCenters.forEach(center => {
                const status = center.is_full
                    ? "<span style='color:red;font-weight:bold;'>Full</span>"
                    : "<span style='color:green;font-weight:bold;'>Available</span>";
                const marker = L.marker([center.lat, center.lng])
                    .addTo(map)
                    .bindPopup(`${center.name}<br>Status: ${status}<br>Safe for: ${center.safe_for.join(", ")}`);
                markers.push(marker);
            });
        });
</script>
</body>
</html>
